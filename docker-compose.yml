# ATTN Protocol - Combined Docker Compose
# Spins up both the relay and node services
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d relay        # Start relay only
#   docker compose up -d node         # Start node only
#   docker compose logs -f            # Follow logs
#   docker compose down               # Stop all services
#
# Prerequisites:
#   - Copy packages/relay/env.example to packages/relay/.env
#   - Copy packages/node/env.example to packages/node/.env
#   - Update .env files with your configuration

name: attn_protocol

services:
  relay:
    container_name: attn-protocol.relay
    image: org.attnprotocol.relay:latest
    build:
      context: ./packages/relay
      dockerfile: Dockerfile
    ports:
      - "8010:8008"
    env_file:
      - ./packages/relay/.env
    volumes:
      - relay-data:/data
    networks:
      - attn-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --server-response http://localhost:8008 2>&1 | grep -q '400\\|200' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  node:
    container_name: attn-protocol.node
    image: org.attnprotocol.node:latest
    build:
      context: .
      dockerfile: packages/node/Dockerfile
    env_file:
      - ./packages/node/.env
    environment:
      # Override relay URL to use internal Docker network
      # The node will connect to the relay via the service name
      NODE_SERVICE_NOSTR_RELAY_URLS_NOAUTH: ws://relay:8008
    networks:
      - attn-network
    depends_on:
      relay:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*src/index.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  attn-network:
    driver: bridge

volumes:
  relay-data:
